{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Books - Library Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-size: cover;
      min-height: 100vh;
      color: #fff;
    }
    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      color: #212529;
    }
    .navbar {
      background-color: rgba(3, 9, 16, 0.9);
    }
    .section-title {
      font-size: 2rem;
      font-weight: bold;
      color: #080202;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
    }
    .form-label {
      font-weight: 500;
      color: #212529;
    }
    footer {
      color: #fff;
    }
    .cover-thumb { max-width:120px; height:auto; border-radius:6px; display:block; margin-top:6px; }
  </style>
</head>
<body>

<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="#">ðŸ“š Library Management System</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
  </div>
</nav>

<!-- Main Content -->
<div class="container mt-4">
  <div class="text-start mb-3">
    <a href="{% url 'admin_dashboard' %}" class="btn btn-dark">Back</a>
  </div>

  <div class="text-center mb-5">
    <h2 class="section-title">ðŸ“˜ Manage Books</h2>
  </div>

  <!-- Messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <!-- Book Form -->
  <div class="card mb-5 p-4">
    <h5 class="card-title text-center mb-4">
      {{ edit_book|yesno:"Edit Book,Add New Book" }}
    </h5>

    <form method="post" action="{% url 'manage_books' %}" enctype="multipart/form-data" id="manageBooksForm">
      {% csrf_token %}
      <input type="hidden" name="action" value="{% if edit_book %}edit{% else %}add{% endif %}">
      {% if edit_book %}
        <input type="hidden" name="book_id" value="{{ edit_book.id }}">
      {% endif %}

      <div class="row g-3">

        <!-- Cover Image -->
        <div class="col-12 col-md-6">
          <label class="form-label">Cover Image</label>
          {% if edit_book and edit_book.cover_image %}
            <div class="mb-2">
              <div class="small text-muted">Current cover:</div>
              <img src="{{ edit_book.cover_image.url }}" class="cover-thumb" alt="Current cover">
              <div class="form-text">{{ edit_book.cover_image.name }}</div>
            </div>
          {% endif %}
          <input type="file" name="cover_image" class="form-control" accept="image/*">
          <div class="form-text">Choose a file to replace the current cover (optional).</div>
        </div>

        {% if edit_book %}
        <div class="col-md-3">
          <label class="form-label">Record ID</label>
          <input class="form-control" type="text" value="{{ edit_book.id }}" disabled>
        </div>
        {% endif %}

        <div class="{% if edit_book %}col-md-9{% else %}col-md-6{% endif %}">
          <label class="form-label">Title</label>
          <input type="text" name="title" class="form-control"
                 value="{{ edit_book.title|default_if_none:''|escape }}" required>
        </div>

        <!-- Author -->
        <div class="col-md-6">
          <label class="form-label">Author</label>
          <input type="text" name="author" list="authors-list" class="form-control"
                 value="{{ edit_book.author.name|default_if_none:''|escape }}" autocomplete="off">
          <datalist id="authors-list">
            {% for a in authors %}
              <option value="{{ a.name }}"></option>
            {% endfor %}
          </datalist>
        </div>

        <!-- Category -->
        <div class="col-md-6">
          <label class="form-label">Category</label>
          <input type="text" name="category" list="categories-list" class="form-control"
                 value="{{ edit_book.category.name|default_if_none:''|escape }}" autocomplete="off">
          <datalist id="categories-list">
            {% for c in categories %}
              <option value="{{ c.name }}"></option>
            {% endfor %}
          </datalist>
        </div>

        <div class="col-md-4">
          <label class="form-label">ISBN</label>
          <input type="text" name="isbn" class="form-control" value="{{ edit_book.isbn|default_if_none:''|escape }}">
        </div>

        <div class="col-md-4">
          <label class="form-label">Publisher</label>
          <input type="text" name="publisher" class="form-control" value="{{ edit_book.publisher|default_if_none:''|escape }}">
        </div>

        <div class="col-md-4">
          <label class="form-label">Publication Date</label>
          <input type="date" name="publication_date" class="form-control"
                 {% if edit_book and edit_book.publication_date %}value="{{ edit_book.publication_date|date:'Y-m-d' }}"{% endif %}>
        </div>

        <div class="col-12">
          <label class="form-label">Description</label>
          <textarea name="description" class="form-control" rows="3">{{ edit_book.description|default_if_none:'' }}</textarea>
        </div>

        <div class="col-md-6">
          <label class="form-label">Total Copies</label>
          <input type="number" min="0" name="total_copies"
                 class="form-control"
                 value="{{ edit_book.total_copies|default_if_none:1 }}">
        </div>

        <div class="col-md-6">
          <label class="form-label">Available Copies</label>
          <input type="number" min="0" name="available_copies"
                 class="form-control"
                 value="{{ edit_book.available_copies|default_if_none:1 }}">
        </div>

        <!-- SUBMIT BUTTON WITH DISABLE CONDITION -->
        <div class="text-center mt-4">
          <button type="submit"
                  class="btn btn-success me-2"
                  {% if disable_submit %}disabled aria-disabled="true" title="Available copies cannot exceed total copies."{% endif %}>
            {% if edit_book %}Update Book{% else %}Add Book{% endif %}
          </button>

          {% if edit_book %}
            <a href="{% url 'manage_books' %}" class="btn btn-outline-secondary">Cancel</a>
          {% endif %}
        </div>

      </div>
    </form>
  </div>

  <!-- Book List -->
  <div class="card p-4">
    <h5 class="card-title text-center mb-4">ðŸ“š All Books</h5>
    <div class="table-responsive">

      <table class="table table-bordered table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Cover</th>
            <th>Author</th>
            <th>Category</th>
            <th>ISBN</th>
            <th>Publisher</th>
            <th>Publication Date</th>
            <th>Description</th>
            <th>Available</th>
            <th>Actions</th>
          </tr>
        </thead>

        <tbody>
          {% for book in books %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ book.title }}</td>
              <td>
                {% if book.cover_image %}
                  <img src="{{ book.cover_image.url }}" style="width:60px; height:80px; object-fit:cover; border-radius:5px;">
                {% else %}
                  <span class="text-muted">No Image</span>
                {% endif %}
              </td>
              <td>{{ book.author.name }}</td>
              <td>{{ book.category.name }}</td>
              <td>{{ book.isbn }}</td>
              <td>{{ book.publisher }}</td>
              <td>{{ book.publication_date|date:"d-m-Y" }}</td>
              <td>{{ book.description }}</td>
              <td>{{ book.available_copies }} / {{ book.total_copies }}</td>
              <td>
                <a href="?edit={{ book.id }}" class="btn btn-sm btn-warning">Edit</a>
                <form method="post" action="{% url 'manage_books' %}" style="display:inline-block;">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="delete">
                  <input type="hidden" name="book_id" value="{{ book.id }}">
                  <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete {{ book.title }}?');">Delete</button>
                </form>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="11" class="text-center">No books found.</td></tr>
          {% endfor %}
        </tbody>

      </table>
    </div>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // find elements
    const totalInput = document.querySelector('input[name="total_copies"]');
    const availableInput = document.querySelector('input[name="available_copies"]');
    const submitBtn = document.querySelector('#manageBooksForm button[type="submit"]');

    // safety: bail out if elements not found
    if (!totalInput || !availableInput || !submitBtn) return;

    function parseNumber(el) {
      const v = parseInt(el.value, 10);
      return Number.isFinite(v) ? v : 0;
    }

    function checkAndToggle() {
      const total = parseNumber(totalInput);
      const available = parseNumber(availableInput);

      if (available > total) {
        submitBtn.disabled = true;
        submitBtn.setAttribute('aria-disabled', 'true');
        // keep the title to explain why
        submitBtn.title = submitBtn.title || "Available copies cannot exceed total copies.";
      } else {
        submitBtn.disabled = false;
        submitBtn.removeAttribute('aria-disabled');
        // remove tip if it was set by server (optional)
        if (submitBtn.getAttribute('title') === "Available copies cannot exceed total copies.") {
          submitBtn.removeAttribute('title');
        }
      }
    }

    // run once on load to sync client with server
    checkAndToggle();

    // listen for user edits
    totalInput.addEventListener('input', checkAndToggle);
    availableInput.addEventListener('input', checkAndToggle);
  });
</script>

<!-- Footer -->
<footer class="text-center py-3 bg-dark bg-opacity-75 text-white mt-5">
  <p class="mb-0">Â© 2025 Library Management System</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
